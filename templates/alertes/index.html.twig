{% extends 'base.html.twig' %}

{% block title %}Alertes{% endblock %}
{% block header_title %}Alertes & Notifications{% endblock %}
{% block header_subtitle %}Centre de surveillance et configuration{% endblock %}

{% block body %}
<!-- Date Filter Bar -->
<div class="filter-bar mb-20">
    <div class="filter-bar-content">
        <div class="filter-section filter-title">
            <i class="fas fa-filter"></i>
            <span>Période</span>
        </div>
        <div class="filter-section filter-buttons">
            <a href="{{ path('app_alertes', {periode: '7jours'}) }}" class="filter-btn {{ periode == '7jours' ? 'active' : '' }}">7 jours</a>
            <a href="{{ path('app_alertes', {periode: '30jours'}) }}" class="filter-btn {{ periode == '30jours' ? 'active' : '' }}">30 jours</a>
            <a href="{{ path('app_alertes', {periode: '3mois'}) }}" class="filter-btn {{ periode == '3mois' ? 'active' : '' }}">3 mois</a>
        </div>
        <div class="filter-divider"></div>
        <form method="GET" action="{{ path('app_alertes') }}" class="filter-section filter-custom">
            <label>Du</label>
            <input type="date" name="dateDebut" value="{{ dateDebut }}" class="filter-date">
            <label>Au</label>
            <input type="date" name="dateFin" value="{{ dateFin }}" class="filter-date">
            <input type="hidden" name="periode" value="personnalise">
            <button type="submit" class="filter-apply-btn">
                <i class="fas fa-check"></i> Appliquer
            </button>
        </form>
    </div>
</div>

<!-- KPI Header Cards -->
<div class="kpi-header-grid mb-30">
    <div class="kpi-header-card {{ alertCount > 0 ? 'deficit' : '' }}">
        <div class="kpi-header-icon {{ alertCount > 0 ? 'danger' : 'success' }}">
            <i class="fas fa-bell"></i>
        </div>
        <div class="kpi-header-content">
            <span class="kpi-header-label">ALERTES ACTIVES</span>
            <span class="kpi-header-value">{{ alertCount }}</span>
            <span class="kpi-header-sublabel">Sur la période</span>
        </div>
    </div>

    <div class="kpi-header-card">
        <div class="kpi-header-icon info">
            <i class="fas fa-clipboard-check"></i>
        </div>
        <div class="kpi-header-content">
            <span class="kpi-header-label">RÈGLES ACTIVES</span>
            <span class="kpi-header-value">{{ ruleCount }}</span>
            <span class="kpi-header-sublabel">Indicateurs surveillés</span>
        </div>
    </div>

    <div class="kpi-header-card {{ itm.classification == 'INTERVENTION' ? 'deficit' : '' }}">
        <div class="kpi-header-icon {{ itm.classification == 'NORMAL' ? 'success' : (itm.classification == 'VIGILANCE' ? 'warning' : 'danger') }}">
            <i class="fas fa-tachometer-alt"></i>
        </div>
        <div class="kpi-header-content">
            <span class="kpi-header-label">INDICE TENSION</span>
            <span class="kpi-header-value">{{ itm.score }}</span>
            <span class="kpi-header-sublabel">{{ itm.label }}</span>
        </div>
    </div>

    <div class="kpi-header-card highlight">
        <div class="kpi-header-content">
            <span class="kpi-header-label">JOURS ANALYSÉS</span>
            <span class="kpi-header-value">{{ joursAnalyses }}</span>
            <span class="kpi-header-sublabel" style="color: rgba(255,255,255,0.7);">{{ dateDebut|date('d/m/Y') }} — {{ dateFin|date('d/m/Y') }}</span>
        </div>
        <div class="kpi-header-icon"><i class="fas fa-calendar-alt"></i></div>
    </div>
</div>

<!-- Alert Status Box -->
{% if alertCount > 0 %}
<div class="alert-box alert-danger mb-30">
    <i class="fas fa-exclamation-triangle alert-icon"></i>
    <div class="alert-content">
        <h4>⚠️ Attention : {{ alertCount }} anomalie(s) détectée(s)</h4>
        <p>Certains indicateurs ont dépassé les seuils critiques sur la période sélectionnée.</p>
    </div>
    <form action="{{ path('app_alertes_recalculate') }}" method="post" class="ml-auto">
        <input type="hidden" name="dateDebut" value="{{ dateDebut }}">
        <input type="hidden" name="dateFin" value="{{ dateFin }}">
        <input type="hidden" name="periode" value="{{ periode }}">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i> Recalculer
        </button>
    </form>
</div>
{% else %}
<div class="alert-box alert-success mb-30">
    <i class="fas fa-check-circle alert-icon"></i>
    <div class="alert-content">
        <h4>✅ Tous les systèmes sont nominaux</h4>
        <p>Aucune anomalie détectée sur la période du {{ dateDebut|date('d/m/Y') }} au {{ dateFin|date('d/m/Y') }}.</p>
    </div>
    <form action="{{ path('app_alertes_recalculate') }}" method="post" class="ml-auto">
        <input type="hidden" name="dateDebut" value="{{ dateDebut }}">
        <input type="hidden" name="dateFin" value="{{ dateFin }}">
        <input type="hidden" name="periode" value="{{ periode }}">
        <button type="submit" class="btn btn-outline">
            <i class="fas fa-sync-alt"></i> Recalculer
        </button>
    </form>
</div>
{% endif %}

<!-- Main Grid -->
<div class="grid-2">
    <!-- Configuration Table -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-sliders-h"></i>
                Règles d'Intervention Configurées
            </h3>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Indicateur</th>
                        <th>Vigilance</th>
                        <th>Intervention</th>
                        <th>Sens</th>
                        <th>Poids</th>
                        <th>Valeur</th>
                        <th>État</th>
                    </tr>
                </thead>
                <tbody>
                    {% for regle in regles %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center gap-10">
                                <i class="fas fa-chart-line text-primary"></i>
                                <strong>{{ regle.indicateur }}</strong>
                            </div>
                        </td>
                        <td>{{ regle.seuilVigilance|number_format(2, ',', ' ') }}</td>
                        <td>{{ regle.seuilIntervention|number_format(2, ',', ' ') }}</td>
                        <td>
                            <span class="sens-badge {{ regle.sens }}">
                                <i class="fas fa-{{ regle.sens == 'hausse' ? 'arrow-up' : 'arrow-down' }}"></i>
                                {{ regle.sens|capitalize }}
                            </span>
                        </td>
                        <td>{{ regle.poids }}</td>
                        <td>
                            {% if regle.valeurActuelle is not null %}
                                {{ regle.valeurActuelle|number_format(2, ',', ' ') }} {{ regle.unite }}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="taux-badge {{ regle.statut == 'ALERTE' ? 'danger' : (regle.statut == 'VIGILANCE' ? 'warning' : 'success') }}">
                                {{ regle.statut }}
                            </span>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted p-20">
                            Aucune règle configurée
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Active Alerts List -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-list-ul"></i>
                Journal des Alertes
            </h3>
        </div>
        <div class="table-container">
            {% if alertes is empty %}
                <div class="text-center p-20 text-muted">
                    <i class="fas fa-check-circle fa-3x mb-10" style="color: var(--success);"></i>
                    <p>Aucune alerte à afficher</p>
                </div>
            {% else %}
                <div class="alerts-list">
                    {% for alerte in alertes %}
                    <div class="alert-item {{ alerte.type }}">
                        <div class="alert-icon-wrapper">
                            <i class="fas fa-{{ alerte.icon }}"></i>
                        </div>
                        <div class="alert-details">
                            <h5>{{ alerte.titre }}</h5>
                            <p>{{ alerte.message }}</p>
                            <span class="alert-time"><i class="far fa-clock"></i> {{ alerte.date|date('d/m/Y') }}</span>
                        </div>
                        <span class="alert-status {{ alerte.type }}">{{ alerte.statut }}</span>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ITM Details Section -->
{% if itm.details|length > 0 %}
<div class="card mt-30">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-chart-bar"></i>
            Détails de l'Indice de Tension
        </h3>
        <div class="itm-global-badge {{ itm.classification == 'NORMAL' ? 'success' : (itm.classification == 'VIGILANCE' ? 'warning' : 'danger') }}">
            Score Global: {{ itm.score }}/100
        </div>
    </div>
    <div class="itm-details-grid">
        {% for detail in itm.details %}
        <div class="itm-detail-card {{ detail.statut == 'ALERTE' ? 'danger' : (detail.statut == 'VIGILANCE' ? 'warning' : '') }}">
            <div class="itm-detail-header">
                <span class="itm-detail-name">{{ detail.indicateur }}</span>
                <span class="itm-detail-weight">Poids: {{ detail.poids }}</span>
            </div>
            <div class="itm-detail-value">{{ detail.valeur|number_format(2, ',', ' ') }}</div>
            <div class="itm-detail-score">
                <div class="progress-bar">
                    <div class="progress-fill {{ detail.statut == 'ALERTE' ? 'danger' : (detail.statut == 'VIGILANCE' ? 'warning' : 'success') }}" style="width: {{ detail.score }}%"></div>
                </div>
                <span>{{ detail.score|number_format(0) }}/100</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<style>
/* Filter Bar */
.filter-bar { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 12px 20px; border-left: 4px solid var(--bcc-primary); }
.filter-bar-content { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
.filter-section { display: flex; align-items: center; gap: 8px; }
.filter-title { font-weight: 700; color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
.filter-title i { color: var(--bcc-primary); }
.filter-buttons { display: flex; gap: 6px; }
.filter-btn { padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); background: var(--bg-secondary); text-decoration: none; transition: var(--transition); border: 1px solid transparent; }
.filter-btn:hover { background: rgba(0, 127, 255, 0.08); color: var(--bcc-primary); border-color: rgba(0, 127, 255, 0.2); }
.filter-btn.active { background: var(--bcc-primary); color: white; }
.filter-divider { width: 1px; height: 24px; background: #e2e8f0; }
.filter-date { padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; }
.filter-custom label { font-size: 0.8rem; color: var(--text-secondary); font-weight: 600; }
.filter-apply-btn { padding: 6px 14px; background: var(--bcc-primary); color: white; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: var(--transition); }
.filter-apply-btn:hover { background: #0056b3; }

.btn-outline { background: transparent; border: 2px solid var(--bcc-primary); color: var(--bcc-primary); }
.btn-outline:hover { background: var(--bcc-primary); color: white; }

/* Dark mode filter bar */
body.dark-mode .filter-bar { background: var(--bg-card); }
body.dark-mode .filter-btn { background: var(--bg-tertiary, #334155); color: var(--text-secondary); }
body.dark-mode .filter-btn:hover { background: rgba(96, 165, 250, 0.15); color: #60a5fa; }
body.dark-mode .filter-btn.active { background: #3b82f6; color: white; }
body.dark-mode .filter-divider { background: #475569; }
body.dark-mode .filter-date { background: var(--bg-tertiary, #334155); border-color: #475569; color: var(--text-primary); }

/* Reusing styles from Finances page for consistency */
.kpi-header-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
.kpi-header-card { background: white; border-radius: var(--border-radius); padding: 20px 25px; display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow); border-left: 4px solid var(--bcc-primary); transition: var(--transition); }
.kpi-header-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
.kpi-header-card.highlight { background: linear-gradient(135deg, #007FFF, #0056b3); color: white; border-left: none; }
.kpi-header-card.deficit { border-left-color: var(--danger); }
.kpi-header-card.highlight .kpi-header-label, .kpi-header-card.highlight .kpi-header-sublabel { color: rgba(255,255,255,0.8); }
.kpi-header-card.highlight .kpi-header-value { color: white; }
.kpi-header-card.highlight .kpi-header-icon { color: white; background: rgba(255,255,255,0.2); }

.kpi-header-icon { width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, rgba(0,127,255,0.15), rgba(0,127,255,0.05)); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; color: var(--bcc-primary); }
.kpi-header-icon.success { background: rgba(16,185,129,0.15); color: var(--success); }
.kpi-header-icon.danger { background: rgba(239,68,68,0.15); color: var(--danger); }
.kpi-header-icon.warning { background: rgba(245,158,11,0.15); color: #b45309; }
.kpi-header-icon.info { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }

.kpi-header-content { display: flex; flex-direction: column; }
.kpi-header-label { font-size: 0.7rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
.kpi-header-value { font-size: 1.6rem; font-weight: 800; color: var(--text-primary); }
.kpi-header-sublabel { font-size: 0.75rem; color: var(--text-secondary); }

.taux-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; }
.taux-badge.success { background: var(--success-light); color: var(--success); }
.taux-badge.danger { background: var(--danger-light); color: var(--danger); }
.taux-badge.warning { background: var(--warning-light); color: #b45309; }

.sens-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 600; }
.sens-badge.hausse { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
.sens-badge.baisse { background: rgba(59, 130, 246, 0.1); color: var(--info); }

.gap-10 { gap: 10px; }
.d-flex { display: flex; }
.align-items-center { align-items: center; }
.ml-auto { margin-left: auto; }
.mt-30 { margin-top: 30px; }

.btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; cursor: pointer; border: none; transition: var(--transition); }
.btn-primary { background: var(--bcc-gradient); color: white; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,127,255,0.3); }

/* Alert List Styles */
.alerts-list { display: flex; flex-direction: column; gap: 15px; padding: 20px; }
.alert-item { display: flex; gap: 15px; padding: 15px; border-radius: 10px; border-left: 4px solid transparent; background: #f8fafc; align-items: center; }
.alert-item.danger { border-left-color: var(--danger); background: #fef2f2; }
.alert-item.warning { border-left-color: var(--warning); background: #fffbeb; }

.alert-icon-wrapper { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
.alert-item.danger .alert-icon-wrapper { background: rgba(239,68,68,0.1); color: var(--danger); }
.alert-item.warning .alert-icon-wrapper { background: rgba(245,158,11,0.1); color: var(--warning); }

.alert-details { flex: 1; }
.alert-details h5 { margin: 0 0 5px 0; font-size: 1rem; color: var(--text-primary); }
.alert-details p { margin: 0 0 8px 0; font-size: 0.9rem; color: var(--text-secondary); }
.alert-time { font-size: 0.8rem; color: #94a3b8; }

.alert-status { padding: 4px 12px; border-radius: 15px; font-size: 0.75rem; font-weight: 700; }
.alert-status.danger { background: var(--danger-light); color: var(--danger); }
.alert-status.warning { background: var(--warning-light); color: #b45309; }

/* ITM Details */
.itm-global-badge { padding: 8px 16px; border-radius: 25px; font-weight: 700; font-size: 0.9rem; }
.itm-global-badge.success { background: var(--success-light); color: var(--success); }
.itm-global-badge.warning { background: var(--warning-light); color: #b45309; }
.itm-global-badge.danger { background: var(--danger-light); color: var(--danger); }

.itm-details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; padding: 20px; }

.itm-detail-card { background: #f8fafc; border-radius: 12px; padding: 20px; border-left: 4px solid var(--bcc-primary); }
.itm-detail-card.warning { border-left-color: var(--warning); }
.itm-detail-card.danger { border-left-color: var(--danger); }

.itm-detail-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
.itm-detail-name { font-weight: 700; color: var(--text-primary); }
.itm-detail-weight { font-size: 0.8rem; color: var(--text-secondary); }
.itm-detail-value { font-size: 1.4rem; font-weight: 800; color: var(--text-primary); margin-bottom: 10px; }

.itm-detail-score { display: flex; align-items: center; gap: 10px; }
.progress-bar { flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
.progress-fill.success { background: var(--success); }
.progress-fill.warning { background: var(--warning); }
.progress-fill.danger { background: var(--danger); }

/* Dark Mode - Alertes */
body.dark-mode .kpi-header-card {
    background: var(--bg-card);
    border-left-color: #60a5fa;
}

body.dark-mode .kpi-header-card .kpi-header-value {
    color: var(--text-primary);
}

body.dark-mode .kpi-header-card .kpi-header-label,
body.dark-mode .kpi-header-card .kpi-header-sublabel {
    color: var(--text-secondary);
}

body.dark-mode .kpi-header-card.highlight {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}

body.dark-mode .kpi-header-card.highlight .kpi-header-value {
    color: white;
}

body.dark-mode .kpi-header-card.deficit {
    border-left-color: #f87171;
}

body.dark-mode .kpi-header-icon {
    background: rgba(96, 165, 250, 0.2);
    color: #60a5fa;
}

body.dark-mode .kpi-header-icon.success {
    background: rgba(52, 211, 153, 0.2);
    color: #34d399;
}

body.dark-mode .kpi-header-icon.danger {
    background: rgba(248, 113, 113, 0.2);
    color: #f87171;
}

body.dark-mode .kpi-header-icon.warning {
    background: rgba(251, 191, 36, 0.2);
    color: #fbbf24;
}

body.dark-mode .kpi-header-icon.info {
    background: rgba(96, 165, 250, 0.2);
    color: #60a5fa;
}

body.dark-mode .alert-item {
    background: #334155;
}

body.dark-mode .alert-item.danger {
    background: rgba(239, 68, 68, 0.1);
}

body.dark-mode .alert-item.warning {
    background: rgba(245, 158, 11, 0.1);
}

body.dark-mode .alert-details h5 {
    color: var(--text-primary);
}

body.dark-mode .alert-details p {
    color: var(--text-secondary);
}

body.dark-mode .itm-detail-card {
    background: #334155;
}

body.dark-mode .itm-detail-name,
body.dark-mode .itm-detail-value {
    color: var(--text-primary);
}

body.dark-mode .itm-detail-weight {
    color: var(--text-secondary);
}

body.dark-mode .progress-bar {
    background: #475569;
}

body.dark-mode .sens-badge.hausse {
    background: rgba(248, 113, 113, 0.2);
}

body.dark-mode .sens-badge.baisse {
    background: rgba(96, 165, 250, 0.2);
}

@media (max-width: 1200px) { .kpi-header-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .kpi-header-grid, .grid-2 { grid-template-columns: 1fr; } }
</style>
{% endblock %}
